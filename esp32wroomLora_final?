esphome:
  name: esp32-wroom-chicken-rx-tx
  friendly_name: ESP32 WROOM Chicken RX/TX

external_components:
  - source: github://pr#7490
    components: [ sx127x ]

esp32:
  board: esp32dev
  framework:
    type: arduino

logger:
  level: DEBUG

wifi:
  ssid: "IOT_Balegem"
  password: "UN1Jeh3O3S"

  reboot_timeout: 0s
  power_save_mode: none

  on_connect:
    - logger.log:
        format: "WiFi verbonden. IP: %s, RSSI: %d dBm"
        args: ['WiFi.localIP().toString().c_str()', 'WiFi.RSSI()']

  on_disconnect:
    - logger.log: "WiFi verbinding verbroken, probeer opnieuw..."

  ap:
    ssid: "esp32_lora_fallback"
    password: "12345678"

captive_portal:

api:
  encryption:
    key: "cV4s1Y6mO6d6+XwcvFmgc7xvPZ+5nGh7d3bJDxKXnTw="

ota:
  platform: esphome
  password: "OfuIQi4Wd7"

# SPI-bus naar RFM95W (ESP32 WROOM-32D)
spi:
  id: bus_a
  clk_pin: GPIO18      # SCK
  mosi_pin: GPIO23     # MOSI
  miso_pin: GPIO19     # MISO

# SX127x (RFM95W) LoRa-config
sx127x:
  id: lora_radio
  spi_id: bus_a
  cs_pin: GPIO5        # NSS/CS
  rst_pin: GPIO14      # RESET
  dio0_pin: GPIO26     # DIO0
  frequency: 868000000
  modulation: LORA
  bandwidth: 125_0kHz
  spreading_factor: 7
  coding_rate: CR_4_5
  sync_value: 0x12          # zelfde als Arduino-LoRa
  crc_enable: true
  preamble_size: 8
  rx_start: true

  # Wanneer een JSON-pakket van de Arduino binnenkomt
  on_packet:
    then:
      - lambda: |-
          // x = std::vector<uint8_t> payload
          ESP_LOGI("lora", "RX packet, len=%u", (unsigned) x.size());
          ESP_LOGI("lora", "RX raw: %s", format_hex(x).c_str());

          std::string s(x.begin(), x.end());
          ESP_LOGI("lora", "RX text: %s", s.c_str());
          ESP_LOGI("lora", "RSSI=%.2f dB, SNR=%.2f dB", rssi, snr);

          // Verwachte JSON-payload van Arduino:
          // {"light":512,"threshold":600,"door":"OPEN","reedTop":0,"reedBottom":1}

          auto get_int = [&](const char *key) -> int {
            std::string k(key);
            size_t pos = s.find(k);
            if (pos == std::string::npos) return -1;
            pos += k.size();
            size_t end = s.find_first_of(",}", pos);
            if (end == std::string::npos) end = s.size();
            std::string num = s.substr(pos, end - pos);
            return atoi(num.c_str());
          };

          auto get_str = [&](const char *key) -> std::string {
            std::string k(key);
            size_t pos = s.find(k);
            if (pos == std::string::npos) return "";
            pos += k.size();
            size_t end = s.find('"', pos);
            if (end == std::string::npos) return "";
            return s.substr(pos, end - pos);
          };

          int light_val       = get_int("\"light\":");
          int threshold_val   = get_int("\"threshold\":");
          int reed_top_val    = get_int("\"reedTop\":");
          int reed_bottom_val = get_int("\"reedBottom\":");
          std::string door    = get_str("\"door\":\"");

          if (light_val >= 0) {
            id(lora_light).publish_state(light_val);
          }
          if (threshold_val >= 0) {
            id(lora_threshold_rx).publish_state(threshold_val);
          }

          if (!door.empty()) {
            id(lora_door_state).publish_state(door.c_str());
          }

          if (reed_top_val == 0 || reed_top_val == 1) {
            id(lora_reed_top).publish_state(reed_top_val == 1);
          }

          if (reed_bottom_val == 0 || reed_bottom_val == 1) {
            id(lora_reed_bottom).publish_state(reed_bottom_val == 1);
          }

          // RSSI en SNR als sensoren publiceren
          id(lora_rssi).publish_state(rssi);
          id(lora_snr).publish_state(snr);

          // Timestamp laatste ontvangst (UNIX-timestamp)
          id(lora_last_rx).publish_state(id(esptime).now().timestamp);

sensor:
  - platform: template
    id: lora_light
    name: "Kippenluik lichtwaarde"
    icon: "mdi:brightness-5"
    accuracy_decimals: 0
    update_interval: never
    state_class: measurement

  - platform: template
    id: lora_threshold_rx
    name: "Kippenluik drempel (0-1023)"
    icon: "mdi:tune-variant"
    accuracy_decimals: 0
    update_interval: never
    state_class: measurement

  - platform: template
    id: lora_rssi
    name: "LoRa RSSI"
    unit_of_measurement: "dBm"
    icon: "mdi:signal-cellular-3"
    accuracy_decimals: 1
    update_interval: never
    device_class: signal_strength
    state_class: measurement
    entity_category: diagnostic

  - platform: template
    id: lora_snr
    name: "LoRa SNR"
    unit_of_measurement: "dB"
    icon: "mdi:waveform"
    accuracy_decimals: 1
    update_interval: never
    state_class: measurement
    entity_category: diagnostic

  - platform: template
    id: lora_last_rx
    name: "LoRa laatste ontvangst"
    device_class: timestamp
    entity_category: diagnostic
    accuracy_decimals: 1
    update_interval: never

  - platform: template
    id: lora_last_tx
    name: "LoRa laatste verzending"
    device_class: timestamp
    entity_category: diagnostic
    accuracy_decimals: 1
    update_interval: never

  - platform: wifi_signal
    name: "WiFi signaalsterkte"
    update_interval: 60s
    entity_category: diagnostic

binary_sensor:
  - platform: template
    id: lora_reed_top
    name: "Kippenluik bovenste reed"
    device_class: opening

  - platform: template
    id: lora_reed_bottom
    name: "Kippenluik onderste reed"
    device_class: opening

  - platform: status
    name: "ESP32 status"
    entity_category: diagnostic

text_sensor:
  - platform: template
    id: lora_door_state
    name: "Kippenluik status"
    icon: "mdi:gate"

  - platform: wifi_info
    ip_address:
      name: "ESP32 IP adres"
      entity_category: diagnostic

number:
  - platform: template
    id: lora_threshold
    name: "Kippenluik threshold (0-255 naar LoRa)"
    min_value: 0
    max_value: 255
    step: 1
    optimistic: true
    restore_value: true
    icon: "mdi:tune-variant"
    mode: box
    entity_category: config
    on_value:
      - lambda: |-
          // Eerste run (tijdens boot) overslaan om SPI-fouten te vermijden
          static bool first_run = true;
          if (first_run) {
            first_run = false;
            ESP_LOGD("lora", "Eerste init van lora_threshold, geen LoRa TX.");
            return;
          }

          uint8_t thr = static_cast<uint8_t>(x);
          std::vector<uint8_t> pkt;
          pkt.push_back('T');   // commando type 'T' = threshold
          pkt.push_back(thr);   // 0-255

          id(lora_radio).transmit_packet(pkt);
          ESP_LOGI("lora",
                   "TX threshold packet: cmd='T', val=%u",
                   (unsigned) thr);

          id(lora_last_tx).publish_state(id(esptime).now().timestamp);

time:
  - platform: homeassistant
    id: esptime

button:
  - platform: template
    name: "Kippenluik status opvragen"
    icon: "mdi:refresh"
    entity_category: config
    on_press:
      - lambda: |-
          std::vector<uint8_t> pkt;
          pkt.push_back('S');   // 'S' = Status request command

          // versturen, geen returnwaarde
          id(lora_radio).transmit_packet(pkt);
          ESP_LOGI("lora", "TX status request");
